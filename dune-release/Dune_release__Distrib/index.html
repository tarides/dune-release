<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Dune_release__Distrib (dune-release.Dune_release__Distrib)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../index.html">dune-release</a></span></nav><header><h1><span class="keyword">Module</span> <span class="module-path">Dune_release__Distrib</span></h1></header><h2>Distribution description</h2><h2 id="distrib" class="anchored"><a href="#distrib" class="anchor"></a>Distribution description</h2><div class="spec type" id="type-watermark"><a href="#type-watermark" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>watermark</code><code><span class="keyword"> = </span>string<span class="keyword"> * </span>[ `String of string | `Version | `Version_num | `Name | `Vcs of [ `Commit_id ] | `Opam of Fpath.t option<span class="keyword"> * </span>string<span class="keyword"> * </span>string ]</code><code></code></div><div class="doc"><p>The type for watermarks. A watermark identifier, e.g. <code class="code">&quot;ID&quot;</code> and its
definition:
</p><ul><li><code class="code">`String s</code>, <code class="code">s</code> is the definition.</li><li><code class="code">`Name</code>, is the name of package.</li><li><code class="code">`Version</code>, is the version of the distribution.</li><li><code class="code">`Version_num</code>, is the version of the distribution with a potential
leading <code class="code">'v'</code> or <code class="code">'V'</code> dropped.</li><li><code class="code">`Vcs `Commit_id</code>, is the commit identifier (hash) of the
distribution. May be post-fixed by <code class="code">&quot;dirty&quot;</code> in
<span class="xref-unresolved" title="unresolved reference to &quot;Conf.build_context&quot;">dev package (<code class="code">`Pin</code>) builds</span>.</li><li><code class="code">`Opam (file, field, sep)</code>, is the values of the field
<code class="code">field</code> concatenated with separator <code class="code">sep</code> of the opam file
<code class="code">file</code>, expressed relative to the distribution root directory, if
<code class="code">file</code> is <code class="code">None</code> this is the package's default opam file, see
describe. Not all fields are supported see the value of
<span class="xref-unresolved" title="unresolved reference to &quot;Topkg_care.Opam.File.field_names&quot;"><span class="xref-unresolved" title="unresolved reference to &quot;Topkg_care.Opam.File&quot;"><span class="xref-unresolved" title="unresolved reference to &quot;Topkg_care.Opam&quot;">Topkg_care.Opam</span>.File</span>.field_names</span>. <b>Warning.</b> In
<span class="xref-unresolved" title="unresolved reference to &quot;Conf.build_context&quot;">dev package (<code class="code">`Pin</code>) builds</span>, <code class="code">`Opam</code>
watermarks are only substituted if the package <code class="code">topkg-care</code> is
installed.</li></ul><p>When a file is watermarked with an identifier <code class="code">&quot;ID&quot;</code>, any occurence of
the sequence <code class="code">%%ID%%</code> in its content is substituted by its definition.</p></div></div><div class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>t</code><code></code><code></code></div><div class="doc"><p>The type for describing distribution creation.</p></div></div><div class="spec val" id="val-v"><a href="#val-v" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>v : ?&#8288;watermarks:<a href="index.html#type-watermark">watermark</a> list <span class="keyword">&#8209;&gt;</span> ?&#8288;files_to_watermark:(unit <span class="keyword">&#8209;&gt;</span> (Fpath.t list, Rresult.R.msg) Rresult.result) <span class="keyword">&#8209;&gt;</span> ?&#8288;massage:(unit <span class="keyword">&#8209;&gt;</span> (unit, Rresult.R.msg) Rresult.result) <span class="keyword">&#8209;&gt;</span> ?&#8288;exclude_paths:(unit <span class="keyword">&#8209;&gt;</span> (Fpath.t list, Rresult.R.msg) Rresult.result) <span class="keyword">&#8209;&gt;</span> unit <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-t">t</a></code></div><div class="doc"><p><code class="code">distrib ~watermarks ~files_to_watermark ~massage
      ~exclude_paths ()</code> influences the distribution creation
process performed by the <code class="code">topkg</code> tool.
See the <span class="xref-unresolved" title="unresolved reference to &quot;distdetails&quot;">full details about distribution creation</span>.</p><p>In the following the <em>distribution build directory</em> is a
private clone of the package's source repository's <code class="code">HEAD</code> when
<code class="code">topkg distrib</code> is invoked.
</p><ul><li><code class="code">watermarks</code> defines the source watermarks for the distribution,
defaults to <a href="index.html#val-watermarks">watermarks</a>.</li><li><code class="code">files_to_watermark</code> is invoked in the distribution build
directory to determine the files to watermark, defaults
to <a href="index.html#val-files_to_watermark">files_to_watermark</a>.</li><li><code class="code">massage</code> is invoked in the distribution build directory,
after watermarking, but before archiving. It can be used to
generate distribution time build artefacts. Defaults to <a href="index.html#val-massage">massage</a>.</li><li><code class="code">exclude_paths ()</code> is invoked in the distribution build
directory, after massaging, to determine the paths that are
excluded from being added to the distribution archive. Defaults to
<a href="index.html#val-exclude_paths">exclude_paths</a>.</li></ul></div></div><div class="spec val" id="val-default_watermarks"><a href="#val-default_watermarks" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>default_watermarks : <a href="index.html#type-watermark">watermark</a> list</code></div><div class="doc"><p><code class="code">default_watermarks</code> is the default list of watermarks. It has the following
elements:
</p><ul><li><code class="code">(&quot;NAME&quot;, `Name)</code></li><li><code class="code">(&quot;VERSION&quot;, `Version)</code></li><li><code class="code">(&quot;VERSION_NUM&quot;, `Version_num)</code></li><li><code class="code">(&quot;VCS_COMMIT_ID&quot;, `Vcs [`Commit_id])</code></li><li><code class="code">(&quot;PKG_MAINTAINER&quot;, `Opam (None, &quot;maintainer&quot;, &quot;, &quot;))</code></li><li><code class="code">(&quot;PKG_AUTHORS&quot;, `Opam (None, &quot;authors&quot;, &quot;, &quot;)</code></li><li><code class="code">(&quot;PKG_HOMEPAGE&quot;, `Opam (None, &quot;homepage&quot;, &quot; &quot;)</code></li><li><code class="code">(&quot;PKG_ISSUES&quot;, `Opam (None, &quot;bug-reports&quot;, &quot; &quot;)</code></li><li><code class="code">(&quot;PKG_DOC&quot;, `Opam (None, &quot;doc&quot;, &quot; &quot;))</code></li><li><code class="code">(&quot;PKG_LICENSE&quot;, `Opam (None, &quot;license&quot;, &quot;, &quot;)</code></li><li><code class="code">(&quot;PKG_REPO&quot;, `Opam (None, &quot;dev-repo&quot;, &quot; &quot;))</code></li></ul><p>
Prepending to the list overrides default definitions.</p></div></div><div class="spec val" id="val-default_files_to_watermark"><a href="#val-default_files_to_watermark" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>default_files_to_watermark : unit <span class="keyword">&#8209;&gt;</span> (Fpath.t list, Rresult.R.msg) Rresult.result</code></div><div class="doc"><p><code class="code">default_files_to_watermark ()</code> is the default list of files to
watermark. It is invoked in the distribution build directory and
gets the set of <span class="xref-unresolved" title="unresolved reference to &quot;Vcs.tracked_files&quot;">tracked files</span> of this
directory from which it removes the files that end with <code class="code">.flv</code>,
<code class="code">.gif</code>, <code class="code">.ico</code>, <code class="code">.jpeg</code>, <code class="code">.jpg</code>, <code class="code">.mov</code>, <code class="code">.mp3</code>, <code class="code">.mp4</code>, <code class="code">.otf</code>,
<code class="code">.pdf</code>, <code class="code">.png</code>, <code class="code">.ttf</code>, <code class="code">.woff</code>.</p></div></div><div class="spec val" id="val-default_massage"><a href="#val-default_massage" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>default_massage : unit <span class="keyword">&#8209;&gt;</span> (unit, Rresult.R.msg) Rresult.result</code></div><div class="doc"><p><code class="code">default_massage</code> is the default distribution massaging
function. It is invoked in the distribution build directory and
does nothing.</p></div></div><div class="spec val" id="val-default_exclude_paths"><a href="#val-default_exclude_paths" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>default_exclude_paths : unit <span class="keyword">&#8209;&gt;</span> (Fpath.t list, Rresult.R.msg) Rresult.result</code></div><div class="doc"><p><code class="code">default_exclude_paths ()</code> is the default list of paths to exclude
from the distribution archive. It is invoked in the distribution build
directory and returns the following static set of files.</p><pre><code class="code">      fun () -&gt; Ok [&quot;.git&quot;; &quot;.gitignore&quot;; &quot;.gitattributes&quot;; &quot;.hg&quot;; &quot;.hgignore&quot;;
                    &quot;build&quot;; &quot;Makefile&quot;; &quot;_build&quot;]</code></pre></div></div><div class="spec val" id="val-watermarks"><a href="#val-watermarks" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>watermarks : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-watermark">watermark</a> list</code></div><div class="doc"></div></div><div class="spec val" id="val-files_to_watermark"><a href="#val-files_to_watermark" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>files_to_watermark : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> unit <span class="keyword">&#8209;&gt;</span> (Fpath.t list, Rresult.R.msg) Rresult.result</code></div><div class="doc"></div></div><div class="spec val" id="val-massage"><a href="#val-massage" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>massage : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> unit <span class="keyword">&#8209;&gt;</span> (unit, Rresult.R.msg) Rresult.result</code></div><div class="doc"></div></div><div class="spec val" id="val-exclude_paths"><a href="#val-exclude_paths" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>exclude_paths : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> unit <span class="keyword">&#8209;&gt;</span> (Fpath.t list, Rresult.R.msg) Rresult.result</code></div><div class="doc"></div></div><div class="spec val" id="val-define_watermarks"><a href="#val-define_watermarks" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>define_watermarks : name:string <span class="keyword">&#8209;&gt;</span> version:string <span class="keyword">&#8209;&gt;</span> opam:Fpath.t <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-watermark">watermark</a> list <span class="keyword">&#8209;&gt;</span> (string<span class="keyword"> * </span>string) list</code></div><div class="doc"></div></div><div class="spec val" id="val-watermark_files"><a href="#val-watermark_files" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>watermark_files : (string<span class="keyword"> * </span>string) list <span class="keyword">&#8209;&gt;</span> Fpath.t list <span class="keyword">&#8209;&gt;</span> (unit, Rresult.R.msg) Rresult.result</code></div><div class="doc"></div></div></body></html>